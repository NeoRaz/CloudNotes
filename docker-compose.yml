version: "3.9"

services:
  server:
    build: ./server
    container_name: cloudnotes-server
    restart: unless-stopped
    volumes:
      - ./server:/var/www/html
    env_file:
      - ./server/.env.docker
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started

  nginx:
    image: nginx:alpine
    container_name: nginx_server
    restart: unless-stopped
    ports:
      - "8080:80"   # expose at http://localhost:8080 (avoid conflict with client)
    volumes:
      - ./server:/var/www/html
      - ./server/docker/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      server:
        condition: service_started

  client:
    build:
      context: ./client
      args:
        - REACT_APP_ENV=docker
        - REACT_APP_API_BASE_URL=http://localhost:8080/api
        - REACT_APP_CLIENT_ID=9ffae7eb-d82b-4de6-9233-612eb75cc1c3 # Change this to your client ID
        - REACT_APP_CLIENT_SECRET=l0EdjHCNUgUNr8pvTq8GKdD1Cb3XFNxWyQUsVc7J  # Change this to your client Secret
        - REACT_APP_SECRET_KEY=Clound-Notes-Client
    container_name: cloudnotes-client
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      nginx:
        condition: service_started

  db:
    image: mysql:8.0
    container_name: mysql_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: cloud_notes
      MYSQL_USER: laravel
      MYSQL_PASSWORD: 123
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3307:3306"   # host=3307, container=3306
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "laravel", "-p123"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: redis_server
    restart: unless-stopped
    ports:
      - "6379:6379"

  queue-worker:
    build: ./server
    env_file:
      - ./server/.env.docker
    container_name: laravel_queue
    restart: unless-stopped
    volumes:
      - ./server:/var/www/html
    command: >
      sh -c "until nc -z db 3306; do
        echo '‚è≥ Waiting for DB...';
        sleep 2;
      done &&
      php artisan queue:work --sleep=3 --tries=3 --verbose"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      server:
        condition: service_started

volumes:
  db_data:
