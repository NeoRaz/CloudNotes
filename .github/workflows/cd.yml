name: CloudNotes CD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      ENVIRONMENT: prod
      PROJECT_ROOT: ${{ github.workspace }}
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      DOCKER_EMAIL: ${{ secrets.DOCKER_EMAIL }}
      KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîë Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: ‚öôÔ∏è Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: üîê Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${KUBE_CONFIG_DATA}" | base64 --decode > $HOME/.kube/config

      - name: üß© Generate production env file
        run: |
          mkdir -p ./deployment/envs
          cat <<EOF > ./deployment/envs/prod.env
          # Namespace
          NAMESPACE=cloudnotes-prod

          # Laravel app
          APP_KEY=${{ secrets.APP_KEY }}
          APP_ENV=prod
          APP_DEBUG=false
          APP_URL=${{ secrets.APP_URL }}
          APP_TIMEZONE=UTC
          APP_LOCALE=en
          APP_FALLBACK_LOCALE=en
          APP_FAKER_LOCALE=en_US

          # Database
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_CONNECTION=mysql
          DB_PORT=3306

          # Redis
          REDIS_HOST=${{ secrets.REDIS_HOST }}
          REDIS_CLIENT=phpredis
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          REDIS_PORT=6379

          # Mail
          MAIL_MAILER=smtp
          MAIL_HOST=${{ secrets.MAIL_HOST }}
          MAIL_PORT=${{ secrets.MAIL_PORT }}
          MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          MAIL_ENCRYPTION=${{ secrets.MAIL_ENCRYPTION }}
          MAIL_FROM_ADDRESS=${{ secrets.MAIL_FROM_ADDRESS }}
          MAIL_FROM_NAME="CloudNotes"

          # Cache / Queue / Session
          CACHE_STORE=database
          CACHE_PREFIX=
          QUEUE_CONNECTION=redis
          SESSION_DRIVER=database
          SESSION_LIFETIME=120
          SESSION_ENCRYPT=false
          SESSION_PATH=/
          SESSION_DOMAIN=null

          # React client
          REACT_APP_NODE_ENV=production
          REACT_APP_API_BASE_URL=${{ secrets.REACT_APP_API_BASE_URL }}
          REACT_APP_CLIENT_ID=${{ secrets.REACT_APP_CLIENT_ID }}
          REACT_APP_CLIENT_SECRET=${{ secrets.REACT_APP_CLIENT_SECRET }}
          REACT_APP_SECRET_KEY=Cloud-Notes-Client

          # Dockerhub creds for prod environment
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD=${{ secrets.DOCKER_PASSWORD }}
          DOCKER_EMAIL=${{ secrets.DOCKER_EMAIL }}
          EOF


      - name: üì¶ Deploy backend (first step)
        run: |
          chmod +x ./deployment/scripts/deploy-first-step.sh
          ./deployment/scripts/deploy-first-step.sh $ENVIRONMENT

      - name: üóÉÔ∏è Run migrations and seed database
        run: |
          ENV_FILE="./deployment/envs/${ENVIRONMENT}.env"
          source "$ENV_FILE"
          kubectl exec -n cloudnotes-prod deploy/server -- php artisan config:clear
          kubectl exec -n cloudnotes-prod deploy/server -- php artisan cache:clear
          kubectl exec -n cloudnotes-prod deploy/server -- php artisan config:cache

          kubectl exec -n "$NAMESPACE" deploy/server -c php-fpm -- php artisan migrate --seed --force

      - name: üíª Build and deploy frontend (second step)
        run: |
          chmod +x ./deployment/scripts/deploy-second-step.sh
          ./deployment/scripts/deploy-second-step.sh $ENVIRONMENT

      - name: üß± Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

